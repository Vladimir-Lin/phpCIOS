<?php
//////////////////////////////////////////////////////////////////////////////
// 多種簡訊平台管理
// 網址：https://www.mitake.com.tw
//////////////////////////////////////////////////////////////////////////////
namespace CIOS                                                               ;
//////////////////////////////////////////////////////////////////////////////
class SmsManager                                                             {
//////////////////////////////////////////////////////////////////////////////
function __construct  (                                                    ) {
  $this -> Initialize (                                                    ) ;
}
//////////////////////////////////////////////////////////////////////////////
function __destruct   (                                                    ) {
}
//////////////////////////////////////////////////////////////////////////////
function Initialize             (                                          ) {
  ////////////////////////////////////////////////////////////////////////////
  $KEY   = "SmsConf"                                                         ;
  $this -> CONFs        = array (                                          ) ;
  $this -> Provider     = ""                                                 ;
  $this -> Plugin       = null                                               ;
  $this -> CurrentError = ""                                                 ;
  ////////////////////////////////////////////////////////////////////////////
  if                            ( ! array_key_exists ( $KEY , $GLOBALS )   ) {
    return false                                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  $this -> CONFs  = $GLOBALS [ $KEY                                        ] ;
  ////////////////////////////////////////////////////////////////////////////
}
//////////////////////////////////////////////////////////////////////////////
function isPrepared   (                                                    ) {
  ////////////////////////////////////////////////////////////////////////////
  $this -> CurrentError = ""                                                 ;
  if                  ( $this -> Plugin == null                            ) {
    $this -> CurrentError = "SMS Provider is not prepared"                   ;
    return false                                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  return true                                                                ;
}
//////////////////////////////////////////////////////////////////////////////
function prepare      ( $Phone , $Provider = ""                            ) {
  ////////////////////////////////////////////////////////////////////////////
  $this -> Provider     = ""                                                 ;
  $this -> Plugin       = null                                               ;
  $this -> CurrentError = ""                                                 ;
  $PICKED               = false                                              ;
  ////////////////////////////////////////////////////////////////////////////
  if                  ( strlen ( $Provider ) > 0                           ) {
    if ( array_key_exists ( $Provider , $this -> CONFs ) )                   {
      $PICKED           = true                                               ;
    }                                                                        ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  if                  ( ! $PICKED                                          ) {
    //////////////////////////////////////////////////////////////////////////
    $KEYs       = array_keys ( $this -> CONFs )                              ;
    $PROPORTION =     [                                                    ] ;
    $TOTAL      = 0                                                          ;
    $CNT        = 0                                                          ;
    //////////////////////////////////////////////////////////////////////////
    foreach           ( $KEYs as $K                                        ) {
      $CNT      = $CNT + 1                                                   ;
      $V        = intval ( $this -> CONFs [ $K ] , 10 )                      ;
      $TOTAL    = $TOTAL + $V                                                ;
      array_push      ( $PROPORTION , $TOTAL                               ) ;
    }                                                                        ;
    //////////////////////////////////////////////////////////////////////////
    if                ( $TOTAL > 0                                         ) {
      ////////////////////////////////////////////////////////////////////////
      $AT       = rand ( 0 , $TOTAL                                        ) ;
      $ID       = 0                                                          ;
      while ( ( $AT >= $PROPORTION [ $ID ] ) and ( ( $ID + 1 ) < $CNT ) )    {
        $ID     = $ID + 1                                                    ;
      }                                                                      ;
      ////////////////////////////////////////////////////////////////////////
      $Provider = $KEYs [ $ID ]                                              ;
      $PICKED   = true                                                       ;
      ////////////////////////////////////////////////////////////////////////
    }                                                                        ;
    //////////////////////////////////////////////////////////////////////////
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  if                  ( ! $PICKED                                          ) {
    //////////////////////////////////////////////////////////////////////////
    $this -> CurrentError = "Provider is indeterminate"                      ;
    //////////////////////////////////////////////////////////////////////////
    return false                                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  $this -> Provider     = $Provider                                          ;
  ////////////////////////////////////////////////////////////////////////////
  switch              ( $Provider                                          ) {
    case "Mitake"                                                            :
      $this -> Plugin   = new SmsMitake  ( )                                 ;
    return true                                                              ;
    case "ITE2"                                                              :
      $this -> Plugin   = new SmsITE2    ( )                                 ;
    return true                                                              ;
    case "Every8d"                                                           :
      $this -> Plugin   = new SmsEvery8d ( )                                 ;
    return true                                                              ;
  }                                                                          ;
  $this -> CurrentError = "Provider is indeterminate"                        ;
  ////////////////////////////////////////////////////////////////////////////
  return false                                                               ;
}
//////////////////////////////////////////////////////////////////////////////
function management                    (                                   ) {
  ////////////////////////////////////////////////////////////////////////////
  if                                   ( ! $this -> isPrepared ( )         ) {
    return false                                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  return $this -> Plugin -> management (                                   ) ;
}
//////////////////////////////////////////////////////////////////////////////
function login                    (                                        ) {
  ////////////////////////////////////////////////////////////////////////////
  if                              ( ! $this -> isPrepared ( )              ) {
    return false                                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  return $this -> Plugin -> login (                                        ) ;
}
//////////////////////////////////////////////////////////////////////////////
function error                    (                                        ) {
  ////////////////////////////////////////////////////////////////////////////
  return ""                                                                  ;
  if                              ( ! $this -> isPrepared ( )              ) {
    return $this -> CurrentError                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  return $this -> Plugin -> error (                                        ) ;
}
//////////////////////////////////////////////////////////////////////////////
function credits                    (                                      ) {
  ////////////////////////////////////////////////////////////////////////////
  if                                ( ! $this -> isPrepared ( )            ) {
    return false                                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  return $this -> Plugin -> credits (                                      ) ;
}
//////////////////////////////////////////////////////////////////////////////
function send                    ( $Phone , $Content , $Title = ""         ) {
  ////////////////////////////////////////////////////////////////////////////
  if                             ( ! $this -> isPrepared ( )               ) {
    return false                                                             ;
  }                                                                          ;
  ////////////////////////////////////////////////////////////////////////////
  return $this -> Plugin -> send ( $Phone , $Content , $Title              ) ;
}
//////////////////////////////////////////////////////////////////////////////
}
//////////////////////////////////////////////////////////////////////////////
?>
